wysihtml.commands.addTableCells={exec:function(t,e,i){if(t.tableSelection&&t.tableSelection.start&&t.tableSelection.end){var s=wysihtml.dom.table.orderSelectionEnds(t.tableSelection.start,t.tableSelection.end);"before"==i||"above"==i?wysihtml.dom.table.addCells(s.start,i):"after"!=i&&"below"!=i||wysihtml.dom.table.addCells(s.end,i),setTimeout(function(){t.tableSelection.select(s.start,s.end)},0)}},state:function(t,e){return!1}},wysihtml.commands.createTable={exec:function(t,e,i){var s,l,n;if(i&&i.cols&&i.rows&&0<parseInt(i.cols,10)&&0<parseInt(i.rows,10)){for(n=i.tableStyle?'<table style="'+i.tableStyle+'">':"<table>",n+="<tbody>",l=0;l<i.rows;l++){for(n+="<tr>",s=0;s<i.cols;s++)n+="<td><br></td>";n+="</tr>"}n+="</tbody></table>",t.commands.exec("insertHTML",n)}},state:function(t,e){return!1}},wysihtml.commands.deleteTableCells={exec:function(t,e,i){if(t.tableSelection&&t.tableSelection.start&&t.tableSelection.end){var s,l=wysihtml.dom.table.orderSelectionEnds(t.tableSelection.start,t.tableSelection.end),n=wysihtml.dom.table.indexOf(l.start),r=t.tableSelection.table;wysihtml.dom.table.removeCells(l.start,i),setTimeout(function(){(s=wysihtml.dom.table.findCell(r,n))||("row"==i&&(s=wysihtml.dom.table.findCell(r,{row:n.row-1,col:n.col})),"column"==i&&(s=wysihtml.dom.table.findCell(r,{row:n.row,col:n.col-1}))),s&&t.tableSelection.select(s,s)},0)}},state:function(t,e){return!1}},wysihtml.commands.mergeTableCells={exec:function(t,e){t.tableSelection&&t.tableSelection.start&&t.tableSelection.end&&(this.state(t,e)?wysihtml.dom.table.unmergeCell(t.tableSelection.start):wysihtml.dom.table.mergeCellsBetween(t.tableSelection.start,t.tableSelection.end))},state:function(t,e){if(t.tableSelection){var i=t.tableSelection.start,s=t.tableSelection.end;if(i&&s&&i==s&&(wysihtml.dom.getAttribute(i,"colspan")&&1<parseInt(wysihtml.dom.getAttribute(i,"colspan"),10)||wysihtml.dom.getAttribute(i,"rowspan")&&1<parseInt(wysihtml.dom.getAttribute(i,"rowspan"),10)))return[i]}return!1}},function(){var u=wysihtml.dom,p=function(t){this.el=t,this.isColspan=!1,this.isRowspan=!1,this.firstCol=!0,this.lastCol=!0,this.firstRow=!0,this.lastRow=!0,this.isReal=!0,this.spanCollection=[],this.modified=!1},i=function(t,e){t?(this.cell=t,this.table=u.getParentElement(t,{query:"table"})):e&&(this.table=e,this.cell=this.table.querySelectorAll("th, td")[0])};function l(t,e){for(var i,s=[],l=0,n=t.length;l<n;l++)if(i=t[l].querySelectorAll(e))for(var r=i.length;r--;s.unshift(i[r]));return s}function a(t){t.parentNode.removeChild(t)}function f(t,e){t.parentNode.insertBefore(e,t.nextSibling)}function m(t,e){for(var i=t.nextSibling;1!=i.nodeType;)if(i=i.nextSibling,!e||e==i.tagName.toLowerCase())return i;return null}i.prototype={addSpannedCellToMap:function(t,e,i,s,l,n){for(var r=[],o=i+(n?parseInt(n,10)-1:0),a=s+(l?parseInt(l,10)-1:0),h=i;h<=o;h++){void 0===e[h]&&(e[h]=[]);for(var d=s;d<=a;d++)e[h][d]=new p(t),e[h][d].isColspan=l&&1<parseInt(l,10),e[h][d].isRowspan=n&&1<parseInt(n,10),e[h][d].firstCol=d==s,e[h][d].lastCol=d==a,e[h][d].firstRow=h==i,e[h][d].lastRow=h==o,e[h][d].isReal=d==s&&h==i,(e[h][d].spanCollection=r).push(e[h][d])}},setCellAsModified:function(t){if(t.modified=!0,0<t.spanCollection.length)for(var e=0,i=t.spanCollection.length;e<i;e++)t.spanCollection[e].modified=!0},setTableMap:function(){var t,e,i,s,l,n,r,o,a=[],h=this.getTableRows();for(t=0;t<h.length;t++)for(e=h[t],i=this.getRowCells(e),void(n=0)===a[t]&&(a[t]=[]),s=0;s<i.length;s++){for(l=i[s];void 0!==a[t][n];)n++;r=u.getAttribute(l,"colspan"),o=u.getAttribute(l,"rowspan"),r||o?(this.addSpannedCellToMap(l,a,t,n,r,o),n+=r?parseInt(r,10):1):(a[t][n]=new p(l),n++)}return this.map=a},getRowCells:function(t){var e=this.table.querySelectorAll("table"),i=e?l(e,"th, td"):[],s=t.querySelectorAll("th, td");return 0<i.length?wysihtml.lang.array(s).without(i):s},getTableRows:function(){var t=this.table.querySelectorAll("table"),e=t?l(t,"tr"):[],i=this.table.querySelectorAll("tr");return 0<e.length?wysihtml.lang.array(i).without(e):i},getMapIndex:function(t){for(var e=this.map.length,i=this.map&&this.map[0]?this.map[0].length:0,s=0;s<e;s++)for(var l=0;l<i;l++)if(this.map[s][l].el===t)return{row:s,col:l};return!1},getElementAtIndex:function(t){return this.setTableMap(),this.map[t.row]&&this.map[t.row][t.col]&&this.map[t.row][t.col].el?this.map[t.row][t.col].el:null},getMapElsTo:function(t){var e=[];if(this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(t),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var i=this.idx_start;this.idx_start=this.idx_end,this.idx_end=i}if(this.idx_start.col>this.idx_end.col){var s=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=s}if(null!=this.idx_start&&null!=this.idx_end)for(var l=this.idx_start.row,n=this.idx_end.row;l<=n;l++)for(var r=this.idx_start.col,o=this.idx_end.col;r<=o;r++)e.push(this.map[l][r].el);return e},orderSelectionEnds:function(t){if(this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(t),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var e=this.idx_start;this.idx_start=this.idx_end,this.idx_end=e}if(this.idx_start.col>this.idx_end.col){var i=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=i}return{start:this.map[this.idx_start.row][this.idx_start.col].el,end:this.map[this.idx_end.row][this.idx_end.col].el}},createCells:function(t,e,i){for(var s,l=this.table.ownerDocument,n=l.createDocumentFragment(),r=0;r<e;r++){if(s=l.createElement(t),i)for(var o in i)i.hasOwnProperty(o)&&s.setAttribute(o,i[o]);s.appendChild(document.createTextNode("Â ")),n.appendChild(s)}return n},correctColIndexForUnreals:function(t,e){for(var i=this.map[e],s=-1,l=0;l<t;l++)i[l].isReal&&s++;return s},getLastNewCellOnRow:function(t,e){for(var i,s,l=this.getRowCells(t),n=0,r=l.length;n<r;n++)if(i=l[n],!1===(s=this.getMapIndex(i))||void 0!==e&&s.row!=e)return i;return null},removeEmptyTable:function(){var t=this.table.querySelectorAll("td, th");return(!t||0==t.length)&&(a(this.table),!0)},splitRowToCells:function(t){if(t.isColspan){var e=parseInt(u.getAttribute(t.el,"colspan")||1,10),i=t.el.tagName.toLowerCase();if(1<e){var s=this.createCells(i,e-1);f(t.el,s)}t.el.removeAttribute("colspan")}},getRealRowEl:function(t,e){var i=null,s=null;e=e||this.idx;for(var l=0,n=this.map[e.row].length;l<n;l++)if((s=this.map[e.row][l]).isReal&&(i=u.getParentElement(s.el,{query:"tr"})))return i;return null===i&&t&&(i=u.getParentElement(this.map[e.row][e.col].el,{query:"tr"})||null),i},injectRowAt:function(t,e,i,s,l){var n=this.getRealRowEl(!1,{row:t,col:e}),r=this.createCells(s,i);if(n){var o=this.correctColIndexForUnreals(e,t);0<=o?f(this.getRowCells(n)[o],r):n.insertBefore(r,n.firstChild)}else{var a=this.table.ownerDocument.createElement("tr");a.appendChild(r),f(u.getParentElement(l.el,{query:"tr"}),a)}},canMerge:function(t){if(this.to=t,this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(this.to),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var e=this.idx_start;this.idx_start=this.idx_end,this.idx_end=e}if(this.idx_start.col>this.idx_end.col){var i=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=i}for(var s=this.idx_start.row,l=this.idx_end.row;s<=l;s++)for(var n=this.idx_start.col,r=this.idx_end.col;n<=r;n++)if(this.map[s][n].isColspan||this.map[s][n].isRowspan)return!1;return!0},decreaseCellSpan:function(t,e){var i=parseInt(u.getAttribute(t.el,e),10)-1;1<=i?t.el.setAttribute(e,i):(t.el.removeAttribute(e),"colspan"==e&&(t.isColspan=!1),"rowspan"==e&&(t.isRowspan=!1),t.firstCol=!0,t.lastCol=!0,t.firstRow=!0,t.lastRow=!0,t.isReal=!0)},removeSurplusLines:function(){var t,e,i,s,l,n,r;if(this.setTableMap(),this.map){for(i=0,s=this.map.length;i<s;i++){for(r=!0,l=0,n=(t=this.map[i]).length;l<n;l++)if(e=t[l],!(u.getAttribute(e.el,"rowspan")&&1<parseInt(u.getAttribute(e.el,"rowspan"),10)&&!0!==e.firstRow)){r=!1;break}if(r)for(l=0;l<n;l++)this.decreaseCellSpan(t[l],"rowspan")}var o=this.getTableRows();for(i=0,s=o.length;i<s;i++)0==(t=o[i]).childNodes.length&&/^\s*$/.test(t.textContent||t.innerText)&&a(t)}},fillMissingCells:function(){var t=0,e=0,i=null;if(this.setTableMap(),this.map){t=this.map.length;for(var s=0;s<t;s++)this.map[s].length>e&&(e=this.map[s].length);for(var l=0;l<t;l++)for(var n=0;n<e;n++)this.map[l]&&!this.map[l][n]&&0<n&&(this.map[l][n]=new p(this.createCells("td",1)),(i=this.map[l][n-1])&&i.el&&i.el.parent&&f(this.map[l][n-1].el,this.map[l][n].el))}},rectify:function(){return!this.removeEmptyTable()&&(this.removeSurplusLines(),this.fillMissingCells(),!0)},unmerge:function(){if(this.rectify()&&(this.setTableMap(),this.idx=this.getMapIndex(this.cell),this.idx)){var t=this.map[this.idx.row][this.idx.col],e=u.getAttribute(t.el,"colspan")?parseInt(u.getAttribute(t.el,"colspan"),10):1,i=t.el.tagName.toLowerCase();if(t.isRowspan){var s=parseInt(u.getAttribute(t.el,"rowspan"),10);if(1<s)for(var l=1,n=s-1;l<=n;l++)this.injectRowAt(this.idx.row+l,this.idx.col,e,i,t);t.el.removeAttribute("rowspan")}this.splitRowToCells(t)}},merge:function(t){if(this.rectify())if(this.canMerge(t)){for(var e=this.idx_end.row-this.idx_start.row+1,i=this.idx_end.col-this.idx_start.col+1,s=this.idx_start.row,l=this.idx_end.row;s<=l;s++)for(var n=this.idx_start.col,r=this.idx_end.col;n<=r;n++)s==this.idx_start.row&&n==this.idx_start.col?(1<e&&this.map[s][n].el.setAttribute("rowspan",e),1<i&&this.map[s][n].el.setAttribute("colspan",i)):(/^\s*<br\/?>\s*$/.test(this.map[s][n].el.innerHTML.toLowerCase())||(this.map[this.idx_start.row][this.idx_start.col].el.innerHTML+=" "+this.map[s][n].el.innerHTML),a(this.map[s][n].el));this.rectify()}else window.console&&console.log("Do not know how to merge allready merged cells.")},collapseCellToNextRow:function(t){var e=this.getMapIndex(t.el),i=e.row+1,s={row:i,col:e.col};if(i<this.map.length){var l=this.getRealRowEl(!1,s);if(null!==l){var n=this.correctColIndexForUnreals(s.col,s.row);if(0<=n)f(this.getRowCells(l)[n],t.el);else{var r=this.getLastNewCellOnRow(l,i);null!==r?f(r,t.el):l.insertBefore(t.el,l.firstChild)}2<parseInt(u.getAttribute(t.el,"rowspan"),10)?t.el.setAttribute("rowspan",parseInt(u.getAttribute(t.el,"rowspan"),10)-1):t.el.removeAttribute("rowspan")}}},removeRowCell:function(t){t.isReal?t.isRowspan?this.collapseCellToNextRow(t):a(t.el):2<parseInt(u.getAttribute(t.el,"rowspan"),10)?t.el.setAttribute("rowspan",parseInt(u.getAttribute(t.el,"rowspan"),10)-1):t.el.removeAttribute("rowspan")},getRowElementsByCell:function(){var t=[];if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),!1!==this.idx)for(var e=this.map[this.idx.row],i=0,s=e.length;i<s;i++)e[i].isReal&&t.push(e[i].el);return t},getColumnElementsByCell:function(){var t=[];if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),!1!==this.idx)for(var e=0,i=this.map.length;e<i;e++)this.map[e][this.idx.col]&&this.map[e][this.idx.col].isReal&&t.push(this.map[e][this.idx.col].el);return t},removeRow:function(){var t=u.getParentElement(this.cell,{query:"tr"});if(t){if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),!1!==this.idx)for(var e=this.map[this.idx.row],i=0,s=e.length;i<s;i++)e[i].modified||(this.setCellAsModified(e[i]),this.removeRowCell(e[i]));a(t)}},removeColCell:function(t){t.isColspan?2<parseInt(u.getAttribute(t.el,"colspan"),10)?t.el.setAttribute("colspan",parseInt(u.getAttribute(t.el,"colspan"),10)-1):t.el.removeAttribute("colspan"):t.isReal&&a(t.el)},removeColumn:function(){if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),!1!==this.idx)for(var t=0,e=this.map.length;t<e;t++)this.map[t][this.idx.col].modified||(this.setCellAsModified(this.map[t][this.idx.col]),this.removeColCell(this.map[t][this.idx.col]))},remove:function(t){if(this.rectify()){switch(t){case"row":this.removeRow();break;case"column":this.removeColumn()}this.rectify()}},addRow:function(t){var e=this.table.ownerDocument;if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),"below"==t&&u.getAttribute(this.cell,"rowspan")&&(this.idx.row=this.idx.row+parseInt(u.getAttribute(this.cell,"rowspan"),10)-1),!1!==this.idx){for(var i=this.map[this.idx.row],s=e.createElement("tr"),l=0,n=i.length;l<n;l++)i[l].modified||(this.setCellAsModified(i[l]),this.addRowCell(i[l],s,t));switch(t){case"below":f(this.getRealRowEl(!0),s);break;case"above":var r=u.getParentElement(this.map[this.idx.row][this.idx.col].el,{query:"tr"});r&&r.parentNode.insertBefore(s,r)}}},addRowCell:function(t,e,i){var s=t.isColspan?{colspan:u.getAttribute(t.el,"colspan")}:null;t.isReal?"above"!=i&&t.isRowspan?t.el.setAttribute("rowspan",parseInt(u.getAttribute(t.el,"rowspan"),10)+1):e.appendChild(this.createCells("td",1,s)):"above"!=i&&t.isRowspan&&t.lastRow?e.appendChild(this.createCells("td",1,s)):c.isRowspan&&t.el.attr("rowspan",parseInt(u.getAttribute(t.el,"rowspan"),10)+1)},add:function(t){this.rectify()&&("below"!=t&&"above"!=t||this.addRow(t),"before"!=t&&"after"!=t||this.addColumn(t))},addColCell:function(t,e,i){var s,l=t.el.tagName.toLowerCase();switch(i){case"before":s=!t.isColspan||t.firstCol;break;case"after":s=!t.isColspan||t.lastCol||t.isColspan&&t.el==this.cell}if(s){switch(i){case"before":t.el.parentNode.insertBefore(this.createCells(l,1),t.el);break;case"after":f(t.el,this.createCells(l,1))}t.isRowspan&&this.handleCellAddWithRowspan(t,e+1,i)}else t.el.setAttribute("colspan",parseInt(u.getAttribute(t.el,"colspan"),10)+1)},addColumn:function(t){var e,i;if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),"after"==t&&u.getAttribute(this.cell,"colspan")&&(this.idx.col=this.idx.col+parseInt(u.getAttribute(this.cell,"colspan"),10)-1),!1!==this.idx)for(var s=0,l=this.map.length;s<l;s++)(e=this.map[s])[this.idx.col]&&((i=e[this.idx.col]).modified||(this.setCellAsModified(i),this.addColCell(i,s,t)))},handleCellAddWithRowspan:function(t,e,i){for(var s,l,n,r=parseInt(u.getAttribute(this.cell,"rowspan"),10)-1,o=u.getParentElement(t.el,{query:"tr"}),a=t.el.tagName.toLowerCase(),h=this.table.ownerDocument,d=0;d<r;d++)if(s=this.correctColIndexForUnreals(this.idx.col,e+d),o=m(o,"tr"))if(0<s)switch(i){case"before":l=this.getRowCells(o),0<s&&this.map[e+d][this.idx.col].el!=l[s]&&s==l.length-1?f(l[s],this.createCells(a,1)):l[s].parentNode.insertBefore(this.createCells(a,1),l[s]);break;case"after":f(this.getRowCells(o)[s],this.createCells(a,1))}else o.insertBefore(this.createCells(a,1),o.firstChild);else(n=h.createElement("tr")).appendChild(this.createCells(a,1)),this.table.appendChild(n)}},u.table={getCellsBetween:function(t,e){return new i(t).getMapElsTo(e)},addCells:function(t,e){new i(t).add(e)},removeCells:function(t,e){new i(t).remove(e)},mergeCellsBetween:function(t,e){new i(t).merge(e)},unmergeCell:function(t){new i(t).unmerge()},orderSelectionEnds:function(t,e){return new i(t).orderSelectionEnds(e)},indexOf:function(t){var e=new i(t);return e.setTableMap(),e.getMapIndex(t)},findCell:function(t,e){return new i(null,t).getElementAtIndex(e)},findRowByCell:function(t){return new i(t).getRowElementsByCell()},findColumnByCell:function(t){return new i(t).getColumnElementsByCell()},canMerge:function(t,e){return new i(t).canMerge(e)}}}(),function(){var t=wysihtml.views.Composer.prototype.observe,e=function(){var t=function(){this.win.removeEventListener("load",t),this.doc.execCommand("enableObjectResizing",!1,"false"),this.doc.execCommand("enableInlineTableEditing",!1,"false")}.bind(this),e=function(){t.call(this),this.actions.removeListeners(this.sandbox.getIframe(),["focus","mouseup","mouseover"],e)}.bind(this);this.doc.execCommand&&wysihtml.browser.supportsCommand(this.doc,"enableObjectResizing")&&wysihtml.browser.supportsCommand(this.doc,"enableInlineTableEditing")&&(this.sandbox.getIframe?this.actions.addListeners(this.sandbox.getIframe(),["focus","mouseup","mouseover"],e):this.win.addEventListener("load",t)),this.tableSelection=wysihtml.quirks.tableCellsSelection(this.element,this.parent)};wysihtml.Editor.prototype.defaults.handleTables=!0,wysihtml.quirks.tableCellsSelection=function(l,n){var t=function(t){var e=wysihtml.dom.getParentElement(t.target,{query:"td, th"},!1,l);e&&i(e)},i=function(t){c.start=t,c.end=t,c.cells=[t],c.table=d.getParentElement(c.start,{query:"table"},!1,l),c.table&&(r(),d.addClass(t,u),l.addEventListener("mousemove",e),l.addEventListener("mouseup",s),n.fire("tableselectstart").fire("tableselectstart:composer"))},r=function(){if(l){var t=l.querySelectorAll("."+u);if(0<t.length)for(var e=0;e<t.length;e++)d.removeClass(t[e],u)}},o=function(t){for(var e=0;e<t.length;e++)d.addClass(t[e],u)},e=function(t){var e,i=null,s=d.getParentElement(t.target,{query:"td, th"},!1,l);s&&c.table&&c.start&&(i=d.getParentElement(s,{query:"table"},!1,l))&&i===c.table&&(r(),e=c.end,c.end=s,c.cells=d.table.getCellsBetween(c.start,s),1<c.cells.length&&n.composer.selection.deselect(),o(c.cells),c.end!==e&&n.fire("tableselectchange").fire("tableselectchange:composer"))},s=function(t){l.removeEventListener("mousemove",e),l.removeEventListener("mouseup",s),n.fire("tableselect").fire("tableselect:composer"),setTimeout(function(){h()},0)},a=function(t){l.ownerDocument.removeEventListener("click",a),d.getParentElement(t.target,{query:"table"},!1,l)!=c.table&&(r(),c.table=null,c.start=null,c.end=null,n.fire("tableunselect").fire("tableunselect:composer"))},h=function(){l.ownerDocument.addEventListener("click",a)},d=wysihtml.dom,c={table:null,start:null,end:null,cells:null,select:function(t,e){c.start=t,c.end=e,c.table=d.getParentElement(c.start,{query:"table"},!1,l),selectedCells=d.table.getCellsBetween(c.start,c.end),o(selectedCells),h(),n.fire("tableselect").fire("tableselect:composer")}},u="wysiwyg-tmp-selected-cell";return l.addEventListener("mousedown",t),c},wysihtml.views.Composer.prototype.observe=function(){t.call(this),this.config.handleTables&&e.call(this)}}();
//# sourceMappingURL=wysihtml.table_editing.min.js.map